<form id="hpcheckout-shipping-form" action="">
    <div id="shipping-new-address-form">
        <div class="controls controls-row">
                <input type="text" name="shipping[firstname]" title="<?php echo $this->__('First Name') ?>" class="span3 required-entry validate-alpha" value="<?php echo $this->htmlEscape($this->getFirstName()) ?>" placeholder="<?php echo $this->__('First Name') ?>" id="shipping:firstname">
            <div class="span3">
                <input type="text" name="shipping[lastname]" title="<?php echo $this->__('Last Name') ?>" class="span3 required-entry validate-alpha" value="<?php echo $this->htmlEscape($this->getLastName()) ?>" placeholder="<?php echo $this->__('Last Name') ?>" id="shipping:lastname">
            </div>
        </div>
        <div class="controls controls-row">
            <input type="hidden" name="shipping[email]" id="shipping:email" value="<?php echo $this->getCustomer()->getEmail() ?>">
            <input type="hidden" name="shipping[selected]" id="shipping:selected">
            <input type="text" title="<?php echo $this->__('Street Address Line 1') ?>" name="shipping[street][0]" id="shipping:street1" value="<?php echo $this->getAddress()->getStreet(1) ?>" class="span6" placeholder="<?php echo $this->__('Street Address Line 1') ?>">
        </div>
        <div class="controls controls-row">
            <input type="text" title="<?php echo $this->__('Street Address Line 2') ?>" name="shipping[street][1]" id="shipping:street2" value="<?php echo $this->getAddress()->getStreet(2) ?>" class="span6" placeholder="<?php echo $this->__('Street Address Line 2') ?>">
        </div>
       <div class="controls controls-row">
            <div class="clearfix">
        	   <input type="text" title="<?php echo $this->__('Zip Code') ?>" name="shipping[postcode]" id="shipping:postcode" class="span1 validate-zip required-entry" value="<?php echo $this->getAddress()->getPostcode() ?>" placeholder="<?php echo $this->__('Zip') ?>">
               <div id="shipping_zip_info_message" class="span5" style="display:none">
                   Enter a ZIP for City and State
               </div>
        	   <div id="shipping_city_and_state">
                   <div class="span3">
                       <input type="text" title="<?php echo $this->__('City') ?>" name="shipping[city]" class="span3 required-entry" value="<?php echo $this->getAddress()->getCity() ?>" placeholder="<?php echo $this->__('City') ?>" id="shipping:city">
                   </div>
                   <div class="span2">
               	   <select id="shipping:region_id" name="shipping[region_id]" title="<?php echo $this->__('State') ?>" class="span2 validate-select state">
               	       <option value="">
               	        <?php echo $this->__('Please select state') ?>
               	       </option>
               	   </select>
               	   <script type="text/javascript">
               	       $('shipping:region_id').setAttribute('defaultValue', "<?php echo $this->getAddress()->getRegionId() ?>");
               	   </script>
               	</div> 
               	<input type="hidden" id="shipping:region" name="shipping[region]" value="<?php echo $this->htmlEscape($this->getAddress()->getRegion()) ?>" title="<?php echo $this->__('State/Province') ?>" class="span1 hidden-state" style="display:none;">
               </div>
            </div>
        </div>
        <div class="controls controls-row">
            <input type="text" name="shipping[telephone]" title="<?php echo $this->__('Telephone') ?>" class="span2 telephone" id="shipping:telephone" value="<?php echo $this->htmlEscape($this->getAddress()->getTelephone()) ?>" placeholder="Telephone">
            <span style="display:none">
                <?php echo $this->getCountryHtmlSelect('shipping') ?>
            </span>
        </div>
    </div>
</form>
<div class="spinner" style="display: none;">
    <img src="<?php echo $this->getSkinUrl( 'images/ajax-loader.gif' ) ?>">
</div>
<script type="text/javascript">
//hack that empties out faked shipping postcode and telephone for users who select a shipping state which then triggers a shipping cost calculation 
//this way users know their totals before hitting submit
if(jQuery("[id='shipping:postcode']").val()=="T0000" && jQuery("[id='shipping:telephone']").val()=="(T00)-000-0000" ){
        jQuery("[id='shipping:postcode']").val("");
        jQuery("[id='shipping:telephone']").val("");
}

jQuery(document).ready( function() {
    checkoutPayment.getCityAndStateByZip("shipping");

    jQuery( '#shipping\\:postcode' ).change( function() { hpcheckout.update(true); });
    
    jQuery( '#shipping\\:region_id' ).change( function() { 
        jQuery('#shipping\\:region').val(jQuery("#shipping:region_id option:selected").text());
        hpcheckout.update(true); 
    }); 
       
    if( jQuery( '#shipping-address-select' ).length > 0 ) {
        
        if(jQuery( '#shipping-address-select' ).val()!=="") {
            //disable on load
            checkoutPayment.disableAddress(true, 'hpcheckout-shipping-form');
        }
    
        jQuery( '#shipping-address-select' ).bind('change', function() { 
            //enable shipping address to perform update
            checkoutPayment.disableAddress(false, "hpcheckout-shipping-form");
            hpcheckout.switchAddress(this.id);
            
            hpcheckout.update(true);
            //if a shipping address was chosen from the dropdown, disable the form
            if(jQuery("#shipping-address-select").val()!=="") {
                checkoutPayment.disableAddress(true, "hpcheckout-shipping-form");
            }
        });
    }
                
    jQuery( '#billing\\:selected' ).val(jQuery( '#billing-address-select' ).val());
});

jQuery('#shipping\\:street1, #shipping\\:street2').keyup(function(){
    var $this = jQuery(this);
    if($this.val().length > 30 ) {
        $this.val($this.val().substr(0,30));
    }
});

var shippingRegionUpdater = new RegionUpdater('shipping:country_id', 'shipping:region', 'shipping:region_id', countryRegions, undefined, 'shipping:postcode');
//]]>
</script>