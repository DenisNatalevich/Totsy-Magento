<?php
/**
 * Harapartners
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Harapartners License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.Harapartners.com/license
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@Harapartners.com so we can send you a copy immediately.
 * 
 */
?>
 
<?php
/**
 * Catalog index list template
 * Load Top, Live, Upcoming events
 * 
 */
?>
<?php
    $indexDataObj   =   $this->getIndexDataObject();
    $baseUrl 		= 	Mage::getBaseUrl();
    $maxPerSend 	= 	0;
    $timer 			= 	0;
    $topArray 		= 	'';
    $liveArray 		= 	'';
    $upcomingArray  = 	'';	
    if ( $indexDataObj->hasData('top_live_queue') ){
        $topArray = json_decode($indexDataObj->getData('top_live_queue'),true);
    } 
    if ( $indexDataObj->hasData('live_queue') ){
        $liveArray = json_decode($indexDataObj->getData('live_queue'), true);
    }
    if ( $indexDataObj->hasData('upcoming_queue') ){
        $upcomingArray = json_decode($indexDataObj->getData('upcoming_queue'), true);
    }
?>
<?php // include banner if it is enabled
    $bannerActive = Mage::getModel('cms/block')->load('home_banner')->getIsActive();

    if ($bannerActive) { ?>
    
<!-- Carousel
    ================================================== -->
    <div id="myCarousel" class="carousel slide">
      <div class="carousel-inner">
        <div class="item active">
          <?php echo $this->getLayout()->createBlock('promotions/block')
                  ->setBlockId('promotions_banner_view')
                  ->setBlockPageName('home')
                  ->toHtml(); ?>
        </div>
      </div>
      <a class="left carousel-control" href="#myCarousel" data-slide="prev">&lsaquo;</a>
      <a class="right carousel-control" href="#myCarousel" data-slide="next">&rsaquo;</a>
    </div><!-- /.carousel -->
<?php } ?>

<div class="marketing">

    <h1>Introducing Bootstrap.</h1>
    <p class="marketing-byline">Need reasons to love Bootstrap? Look no further.</p>

    <div class="row-fluid">
      <div class="span4">
        <img class="marketing-img" src="assets/img/bs-docs-twitter-github.png">
        <h2>By nerds, for nerds.</h2>
        <p>Built at Twitter by <a href="http://twitter.com/mdo">@mdo</a> and <a href="http://twitter.com/fat">@fat</a>, Bootstrap utilizes <a href="http://lesscss.org">LESS CSS</a>, is compiled via <a href="http://nodejs.org">Node</a>, and is managed through <a href="http://github.com">GitHub</a> to help nerds do awesome stuff on the web.</p>
      </div>
      <div class="span4">
        <img class="marketing-img" src="assets/img/bs-docs-responsive-illustrations.png">
        <h2>Made for everyone.</h2>
        <p>Bootstrap was made to not only look and behave great in the latest desktop browsers (as well as IE7!), but in tablet and smartphone browsers via <a href="./scaffolding.html#responsive">responsive CSS</a> as well.</p>
      </div>
      <div class="span4">
        <img class="marketing-img" src="assets/img/bs-docs-bootstrap-features.png">
        <h2>Packed with features.</h2>
        <p>A 12-column responsive <a href="./scaffolding.html#gridSystem">grid</a>, dozens of components, <a href="./javascript.html">JavaScript plugins</a>, typography, form controls, and even a <a href="./customize.html">web-based Customizer</a> to make Bootstrap your own.</p>
      </div>
    </div>

    <hr class="soften">

    <h1>Built with Bootstrap.</h1>
    <p class="marketing-byline">For even more sites built with Bootstrap, <a href="http://builtwithbootstrap.tumblr.com/" target="_blank">visit the unofficial Tumblr</a> or <a href="./getting-started.html#examples">browse the examples</a>.</p>
    <div class="row-fluid">
      <ul class="thumbnails example-sites">
        <li class="span4">
          <a class="thumbnail" href="http://soundready.fm/" target="_blank">
            <img src="assets/img/example-sites/soundready.png" alt="SoundReady.fm">
          </a>
        </li>
        <li class="span4">
          <a class="thumbnail" href="http://kippt.com/" target="_blank">
            <img src="assets/img/example-sites/kippt.png" alt="Kippt">
          </a>
        </li>
        <li class="span4">
          <a class="thumbnail" href="http://www.gathercontent.com/" target="_blank">
            <img src="assets/img/example-sites/gathercontent.png" alt="Gather Content">
          </a>
        </li>
        <li class="span4">
          <a class="thumbnail" href="http://www.jshint.com/" target="_blank">
            <img src="assets/img/example-sites/jshint.png" alt="JS Hint">
          </a>
        </li>
      </ul>
     </div>

  </div>
  
  
<div class="catalog-events-container container">
    <div class="live-events-container">
    <?php // Live Events ?>
    <?php if (!!$topArray && !empty($topArray)) : ?>
        <section id="events-live" class="tedhack events-grid">
        <?php if (!$bannerActive) : ?>
<!--
            <header class="page-header">
                <h2><img src="/skin/frontend/enterprise/bootstrap/images/iconmonstr-time-8-icon.png" width="50" /> Today's Sales</h2>
            </header>
-->
        <?php endif; ?>
            <ul class="thumbnails">
            <?php foreach ($topArray as $top): ?>
                <?php if(!isset($top['club_only_event']) || !$top['club_only_event']) : ?>
                <?php
                    $endcountRaw = strtotime($top['event_end_date']);
                    $endcount = date("F j, Y, G:i:s", $endcountRaw);
                    $hasProduct = $this->countCategoryProducts($top['entity_id']);
                    $eventDepts = $top['department_label'];
                    $eventAges = $top['age_label'];
                    $maxDiscount = $top['max_discount_pct'];
                    if(!($url = Mage::getModel('core/url_rewrite')->setStoreId(Mage::app()->getStore()->getId())->loadByIdPath('category/'.$top['entity_id'])->getRequestPath())) {
                        $url = 'catalog/category/view/id/'.$top['entity_id'];
                    }
                    $url = Mage::getBaseUrl().$url;
                ?>
                <?php if ($hasProduct && $endcountRaw > Mage::getSingleton('core/date')->timestamp()): ?>
                    <li class="span4 catalog-event event-counter-<?php echo $timer;?>">
                        <a href="<?php echo $url; ?>" class="thumbnail">
                            <div class="more">
                                <div class="more-content">
                                    <p id="time1-<?php echo $timer ?>" class="counter" data-enddate="<?php echo $endcount?>" data-status="live" data-id="<?php echo $timer ?>" data-countertype="event-counter"></p>
                                    <span class="btn btn-primary">SHOP NOW</span>
                                </div>
                            </div>
                            <?php
                                $imgFile = (isset($top['small_image']))
                                ? BP . DS . 'media' . DS . 'catalog' . DS . 'category' . DS . $top['small_image']
                                : BP . DS . 'skin' . DS . 'frontend' . DS . 'enterprise ' . DS . 'bootstrap' . DS . 'images' . DS . 'catalog' . DS . 'product' . DS . 'placeholder' . DS . 'small_image.jpg';
                            ?>
                            <span class="event-link">
                                <img src="<?php echo Mage::helper('service/image')->loadImageFile($imgFile)->constrainOnly(false)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(550,550) ?>" alt="<?php echo $top['name'];?>" />
                            </span>
                            
                            <?php $timer++; ?>
                        </a>
                  <div class="caption">
                    <h3 class="ellipsis"><?php echo $top['name'];?></h3>
                    <p class="up-to">up to <span><?php echo $maxDiscount; ?>% Off!</span></p>
                  </div>
                  
                    </li>
                <?php endif; ?>
                <?php endif; ?>
            <?php endforeach; ?>
            </ul>
        </section><!-- /#events-live -->
    <?php endif; ?>
    
    <?php // ENDING SOON - not functioning, no $endingArray exists - just a placeholder var and code for now ?>
    <?php if (!!$liveArray && !empty($liveArray)) : ?>
    <section id="events-ending" class="tedhack events-grid anchorHack">
        <header class="page-header">
                <h2>Hurry, Ending Soon</h2>
            </header>
            <ul class="thumbnails">
            <?php foreach ($liveArray as $live): ?>
                <?php if(!isset($live['club_only_event']) || !$live['club_only_event']) : ?>
                <?php
                    $endcountRaw = strtotime($live['event_end_date']);
                    $endcount = date("F j, Y, G:i:s", $endcountRaw);
                    $hasProduct = $this->countCategoryProducts($live['entity_id']);
                    $eventDepts = $live['department_label'];
                    $eventAges = $live['age_label'];
                    $maxDiscount = $live['max_discount_pct'];
                    if(!($url = Mage::getModel('core/url_rewrite')->setStoreId(Mage::app()->getStore()->getId())->loadByIdPath('category/'.$live['entity_id'])->getRequestPath())) {
                        $url = 'catalog/category/view/id/'.$live['entity_id'];
                    }
                    $url = Mage::getBaseUrl().$url;
                ?>
                <?php if ($hasProduct && $endcountRaw > Mage::getSingleton('core/date')->timestamp()): ?>
                    <li class="span3 catalog-event event-counter-<?php echo $timer;?>">
                        <a href="<?php echo $url; ?>" class="thumbnail">
                            <div class="more">
                                <div class="more-content">
                                    <p id="time1-<?php echo $timer ?>" class="counter" data-enddate="<?php echo $endcount?>" data-status="live" data-id="<?php echo $timer ?>" data-countertype="event-counter"></p>
                                    <span class="btn btn-primary">SHOP NOW</span>
                                </div>
                            </div>
                            <?php
                                $imgFile = (isset($live['small_image']))
                                ? BP . DS . 'media' . DS . 'catalog' . DS . 'category' . DS . $live['small_image']
                                : BP . DS . 'skin' . DS . 'frontend' . DS . 'enterprise ' . DS . 'bootstrap' . DS . 'images' . DS . 'catalog' . DS . 'product' . DS . 'placeholder' . DS . 'small_image.jpg';
                            ?>
                            <span class="event-link">
                                <img src="<?php echo Mage::helper('service/image')->loadImageFile($imgFile)->constrainOnly(false)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(550,550) ?>" alt="<?php echo $live['name'];?>" />
                            </span>
                            
                            <?php $timer++; ?>
                        </a>
                        <div class="caption">
                    <h3 class="ellipsis"><?php echo $live['name'];?></h3>
                    <p class="up-to">up to <span><?php echo $maxDiscount; ?>% Off!</span></p>
                  </div>
                    </li>
                <?php endif; ?>
                <?php endif; ?>
            <?php endforeach; ?>
            </ul>
        </section><!-- /#events-live -->
    <?php endif; ?>
 
    <?php // Upcoming Events ?>
    <?php if (!!$upcomingArray && !empty($upcomingArray)): ?>
        <section id="events-upcoming" class="tedhack events-grid anchorHack">
            <header class="page-header">
                <h2>Upcoming Sales</h2>
            </header>
            <ul class="thumbnails">
            <?php foreach ($upcomingArray as $up): ?>
                <?php if(!isset($live['club_only_event']) || !$up['club_only_event']) : ?>
                <?php
                    $endcountRaw = strtotime($up['event_start_date']);
                    $endcount = date("F j, Y, G:i:s", $endcountRaw);
                    if(!($url = Mage::getModel('core/url_rewrite')->setStoreId(Mage::app()->getStore()->getId())->loadByIdPath('category/'.$up['entity_id'])->getRequestPath())) {
                        $url = 'catalog/category/view/id/'.$up['entity_id'];
                    }
                    $url = Mage::getBaseUrl().$url;
                ?>
                <li class="span2 catalog-event up-event-counter-<?php echo $timer;?>">
                    <div class="thumbnail">
                        <hgroup>
                            <h5><a href="<?php echo $url; ?>"><?php echo $up['name'];?></a></h5>
                        </hgroup>
                        <?php
                            $imgFile = (isset($up['small_image']))
                            ? BP . DS . 'media' . DS . 'catalog' . DS . 'category' . DS .
                            $up['small_image']
                            : BP . DS . 'skin' . DS . 'frontend' . DS . 'enterprise ' . DS . 'bootstrap' . DS . 'images' . DS . 'catalog' . DS . 'product' . DS . 'placeholder' . DS . 'small_image.jpg';
                        ?>
                        <a class="event-link" href="<?php echo $url; ?>">
                            <img src="<?php echo Mage::helper('service/image')->loadImageFile($imgFile)->resize(165)->keepFrame(FALSE); ?>" width="165px" height="171" alt="<?php echo $up['name'];?>" />
                        </a>
                        <?php $timer++; ?>
                        <p class="opens_in counter" id="time2-<?php echo $timer ?>" data-enddate="<?php echo $endcount?>" data-status="upcoming" data-countertype="up-event-counter"  data-id="<?php echo $timer ?>"></p>
                    </div>
                </li>
            <?php endif; ?>
            <?php endforeach; ?>
            </ul>
        </section><!-- /#events-upcoming -->
    <?php endif; ?>
 
    </div><!-- /.live-events-container -->
</div><!-- /.catalog-events-container -->
<script type="text/javascript">
    jQuery(".counter").each(function(){
        var saleTime = new Date(jQuery(this).data('enddate'));
        var server_now = "<?php echo date('F j, Y, G:i:s' , Mage::app()->getLocale()->storeTimeStamp(Mage::app()->getStore()->getId())); ?>";
        var id = jQuery(this).data('id');
        jQuery(this).countdown({
            until: saleTime,
            layout: getTimerHtml(jQuery(this).data('status'), jQuery(this).data('enddate'), server_now),
            serverSync:retrieveServertime,
            tickInterval: 1, 
            alwaysExpire: true,
            onExpiry: function( event ){
                jQuery(this).html("Completed");
                elem_class = "." + jQuery(this).data('countertype') + '-' + id;
               jQuery(elem_class).remove();
            }
 
        });
    });
 
    function retrieveServertime() {
        var time = null;
        jQuery.ajax({
            url:"<?php echo Mage::getUrl('ajax/servertime/servertime', array('format' => 'string')); ?>",
            async: false,
            success: function(servertime) {
                servertime = jQuery.parseJSON(servertime);
                time =  servertime.time;
            }, 
            error:function () {
                time = "<?php Mage::getModel('core/date')->timestamp(time()); ?>";
            }
        });
        date = new Date(time);
        return date;
    }
    <?php if(!empty($banners)){ ?>
        jQuery(document).ready(function() {
            jQuery('.carousel').carousel();
        });
    <?php } ?>
</script>
