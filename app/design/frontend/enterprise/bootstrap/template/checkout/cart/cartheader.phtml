<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition License
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magentocommerce.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     enterprise_default
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://www.magentocommerce.com/license/enterprise-edition
 */

/**
 * Shoping cart sidebar
 *
 * @see Mage_Checkout_Block_Cart_Sidebar
 */

    $checkoutSession = Mage::getSingleton('checkout/session');
    $countDownTimerHeader= $checkoutSession->getCountDownTimer();
    $timeoutHeader = $checkoutSession->getQuoteItemExpireTime();
    //$endcount_lc_header = date("F j, Y, G:i:s", ($countDownTimerHeader + $timeoutHeader));
    $endcount_lc_header = ($countDownTimerHeader + $timeoutHeader)*1000; //ms
    //Harapartners, yang, get the server time with the frontend JS time
    $serverTime = Mage::helper('service')->getServerTime();
    $quote = $checkoutSession->getQuote();
    $_saving = Mage::helper('sales/order')->calculateEstimatedSavings($quote);
?>

<div class="top-cart dropdown">
<?php
    $_cartQty = Mage::getModel('checkout/cart')->getSummaryQty();
    $_itemsArray = $this->getItems();
    $_updateFlag = $checkoutSession->getCartUpdatedFlag();
    $_mySaving = $this->__('Your savings: %s', Mage::helper('checkout')->formatPrice($_saving));
    
    // store value of cart quantity check
    $_itemsInCart = ( ($_cartQty > 0 && !empty($_itemsArray)) ? true : false );

    // set cart message
    if ($_itemsInCart) :
        $_myCart = $this->__('%s Items', '<span>' . $_cartQty . '</span>');
    else :
        $_myCart = $this->__('%s Items', '<span>0</span> - NO ITEMS');
    endif; 
?>
    
    <?php if ($this->getIsLinkMode() || !$this->getIsNeedToDisplaySideBar()):?>
    <?php Mage::log('link mode:'.print_r($this->getIsLinkMode())); ?>
    <?php Mage::log('display sidebar mode:'.print_r($this->getIsNeedToDisplaySideBar())); ?>
        <div class="block-title no-items">
            <ul class="links cart-link">
                <li ><a href="<?php echo $this->getUrl('checkout/cart'); ?>"><?php echo $_myCart ?><span class="badge badge-inverse">$0.00</span></a></li>
            </ul>
        </div>
        
    <?php else:?>
    
        <?php if ($_itemsInCart):?>
            <div id="usercart-block-title" class="dropdown-toggle block-title" data-toggle="dropdown">
                <strong id="cartHeader"><?php echo $_myCart ?><span><?php echo ' | '.Mage::helper('checkout')->formatPrice($this->getSubtotal()) ?><?php if ($_subtotalInclTax = $this->getSubtotalInclTax()): ?> / <?php echo ' | '.Mage::helper('checkout')->formatPrice($_subtotalInclTax) ?> <?php echo ' | '.Mage::helper('tax')->getIncExcText(true) ?><?php endif; ?></span></strong>
            </div>
        <?php else :?>
            <div id="usercart-block-title" class="block-title no-items">
                <strong id="cartHeader" class="cartempty"><span><?php echo $this->__('You have no items in your shopping cart.'); ?></span></strong>
            </div>
        <?php endif;?>
    
    
    <!-- start mini-cart -->
<div id="topCartContent" class="block-content dropdown-menu" data-item-added="<?php if ( !!$_updateFlag && $_updateFlag ) {echo "true"; $checkoutSession->setCartUpdatedFlag(false);} else echo "false";?>">
    
    <div class="inner-wrapper"><?php // extra div to smooth slideUp and slideDown ?>
    <?php if ($_cartQty > 0 && !empty($_itemsArray)):?>
    <div class="timer-control-box">
        <div class="shipping-date">
        <!-- <span>Estimated Ship Date:</span> -->
        <span id="cart-shipping-date-header" style="display:none"><?php echo date('Y-m-d', Mage::helper('sales/order')->calculateEstimatedShipDate($quote)) ?></span>
        </div>
        <div class="count-down-timer">
        <!-- <span>Item Reserved For:</span> --> 
        <span id="cart-timer-header" style="display:none"></span>
        <script type="text/javascript">
            jQuery(document).ready(function() {
            // @TODO: this countdown JS should be abstracted out to external file if possible (mabye not: cart is ajaxy)            
                var dateObj = new Date();
                var countDownToTime = <?php echo $endcount_lc_header?>;
                var serverTime = <?php echo $serverTime?>;
                var localTime = new Date().getTime();
                countDownToTime = (countDownToTime + (localTime - serverTime));
                dateObj.setTime(countDownToTime);
                //var countToTimeTemplate = (dateObj.getMonth()+1) + ' ' + dateObj.getDate() + ', ' + dateObj.getFullYear() + ' ' + dateObj.getHours() + ':' + dateObj.getMinutes() + ':' + dateObj.getSeconds();
                jQuery("#cart-timer-header").countdown({
                    //date: "12 10, 2011 16:11", or an object counting to a date
                    date: dateObj,
                    htmlTemplate: "%{m} <span class=\"cd-time\">:</span> %{s} <span class=\"cd-time\">minutes</span>",
                    onChange: function( event, timer ){
                    },
                    onComplete: function( event ) {            
                        jQuery(this).html("<span class='over'>no longer reserved</span>");
                        //jQuery("#cartHeader").html("<span>0</span> Items<span> | <span class='price'>$0.00</span></span>");
                        jQuery("#items-info-wrapper").hide();
                        jQuery("div.shipping-date").hide();
                        jQuery("#items-timer-passed").show();
                    },
                        leadingZero: true,
                        direction: "down"
                });
            });
        </script>
       <!--  </div> -->
    </div>
    <?php  endif;?>
    <div id="items-info-wrapper">
        <?php $_items = $this->getItems(); //change from getRecentItems()?>
        <?php if( count($_items) && !empty($_itemsArray) ): ?>
    </div>
    <div id="mini-cart" class="mini-products-list ">
        <?php foreach($_items as $_item): ?>
        <!-- Add Customerize Cart item info -->
        <?php echo $this->getItemHtml($_item) ?>
        <?php endforeach; ?>
    </div>
    <script type="text/javascript">decorateList('mini-cart', 'none-recursive')</script>
    <?php else: ?>
    <p class="block-subtitle">
    
        <?php // @GOTCHA: not using Enterprise.TopCart methods in new design ?>
<!--     <span onclick="Enterprise.TopCart.hideCart()" class="close-btn close" data-dismiss="alert"><?php //echo $this->__('Close'); ?></span> -->
    
        <?php echo $this->__('Recently added item(s)') ?>
    </p>
    <p class="cart-empty">
        <?php echo $this->__('REMOVE You have no items in your shopping cart.'); ?>
    </p>
    <?php endif ?>
    <!-- end mini-cart -->
    <?php if($_cartQty && !empty($_itemsArray)): ?>
    <div>
    <div class="subtotal" style="float:left">
    <?php if ($this->canApplyMsrp()): ?>
    <span class="map-cart-sidebar-total"><?php echo $this->__('ORDER TOTAL WILL BE DISPLAYED BEFORE YOU SUBMIT THE ORDER'); ?></span>
    <?php else: ?>
    <span><?php echo $this->__('Subtotal: ') ?><?php echo Mage::helper('checkout')->formatPrice($this->getSubtotal()) ?>
    <?php if ($_subtotalInclTax = $this->getSubtotalInclTax()): ?> / <?php echo Mage::helper('checkout')->formatPrice($_subtotalInclTax) ?> <?php echo Mage::helper('tax')->getIncExcText(true) ?><?php endif; ?>
    <?php endif; ?>
    </span>
    </div>
    <div style="float:right">
        <a class="btn checkout btn-primary" title="Checkout" href="/checkout/cart/"><strong>Checkout</strong></a>
    </div>
    </div>
    </div>
</div>
    <?php endif ?>
    </div>
    <div id="items-timer-passed" style="display:none;"><p class="cart-empty"><?php echo $this->__('TIMER OUT You have no items in your shopping cart.'); ?></p>
    </div>
    </div>
</div>
    <script type="text/javascript">
    // Cart related JS needs to stay here, load in ajax call
    jQuery(document).ready( function() {
        // Show checkout button if items in cart
        var itemsInCartBool = "<?php echo $_itemsInCart; ?>";
        var headCheckoutBtn = jQuery('#header-checkoutBtn');
        if ( itemsInCartBool == true ) {
            headCheckoutBtn.show();
        }
        
        // Show minicart after item added, then hide after 5 sec
        var topCartContent = jQuery("#topCartContent");
        var topCartUpdated = topCartContent.attr('data-item-added');
        if ( topCartUpdated == 'true' ) {
            topCartContent.show()
            .parent('.top-cart').addClass('open')
            .delay(5000)
            .queue(function(n) {
                topCartContent.removeAttr('style');
                jQuery('.top-cart').removeClass('open');
                n();
            });
        }
    });
    </script>
    <!-- end mini-cart -->
    <?php endif;?>
</div>