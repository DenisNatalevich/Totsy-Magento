<?php $_code=$this->getMethodCode(); ?>
<script type="text/javascript">
//<![CDATA[
    Validation.creditCartTypes.set('JCB', [new RegExp('^(35[0-9]{14}|(2131|1800)[0-9]{11})$'), new RegExp('^([0-9]{3})?$'), true]);
    Validation.creditCartTypes.set('LASER', [new RegExp('^((6304|6706|6771|6709)[0-9]{12}([0-9]{3}))$'), new RegExp('^([0-9]{3})?$'), false]);
    Validation.creditCartTypes.set('UATP', [false, new RegExp('^[0-9]{3}([0-9]{1})?$'), false]);
    Validation.creditCartTypes.set('MCI', [false, new RegExp('^[0-9]{3}([0-9]{1})?$'), false]);
//]]>
	
	//extending validation JS to include validation for rules for cc types displayed with radio buttons
	Validation.add(['validate-cc-type-radio', 'Credit card number does not match credit card type.', function(v, elm) {
                // remove credit card number delimiters such as "-" and space
                elm.value = removeDelimiters(elm.value);
                v         = removeDelimiters(v);
                var ccType = $$('input:checked[type="radio"][name="payment[cc_type]"]').pluck('value');
				if (typeof Validation.creditCartTypes.get(ccType) == 'undefined') {
                    return false;
                } 
                // Other card type or switch or solo card
                if (Validation.creditCartTypes.get(ccType)[0]==false) {
                    return true;
                }
                // Matched credit card type
                var ccMatchedType = '';
				Validation.creditCartTypes.each(function (pair) {
                    if (pair.value[0] && v.match(pair.value[0])) {
                        ccMatchedType = pair.key;
                        throw $break;
                    }
                });
               	if(ccMatchedType != ccType) {
                    return false;
                } 
                return true;
            }],
            ['validate-cc-cvn-radio', 'Please enter a valid credit card verification number.', function(v, elm) {
                var ccType = $$('input:checked[type="radio"][name="payment[cc_type]"]').pluck('value');
                if (typeof Validation.creditCartTypes.get(ccType) == 'undefined') {
                    return false;
                }
                var re = Validation.creditCartTypes.get(ccType)[1];

                if (v.match(re)) {
                    return true;
                }
                return false;
            }]);

</script>

<div class="form-list .one-page-payment" id="payment_form_<?php echo $_code ?>">
<?php $customerId = Mage::getSingleton('customer/session')->getCustomerId(); ?>
<?php $profiles = $this->getProfilesByCustomerId( $customerId ) ?>
<?php
        $profilesCounter = 0;
        foreach( $profiles as $profile ) {
            if($profile->getSubscriptionId() && $profile->getIsDefault()==0 && $profile->getData('saved_by_customer')) {
                $profilesCounter++;
            }
        }
?>
<div>
    <div>
    	<div>
        	<div class="hpcheckout-payment-title" class="pull-left">
        	    <h4 class="legend">Payment Information</h4>
        	</div>
        	<!-- part A of a hack for the radio button error message-->
        	<div>
        	</div>
        	<div class="cc_types use-new-card-wrapper input-box validation-error pull-left">
        		<?php $_ccType = $this->getInfoData('cc_type') ?>
        		 <div id="<?php echo $_code ?>_cc_type">
        		 <?php $i=0; ?>
        		 <?php foreach ($this->getCcAvailableTypes() as $_typeCode => $_typeName): ?>
        		     	<input type="radio" class="validate-cybsersource-cc-type <?php if($i==3) { echo "validate-one-required"; } ?>" name="payment[cc_type]" value="<?php echo $_typeCode ?>" <?php if($_typeCode==$_ccType) { echo "checked"; } ?> > 
        		 <?php $i++; ?>
        		 	<span class="cc">
        		 	    <span title="<?php echo $_typeName; ?>"  class="<?php echo strtolower($_typeCode); ?>" >
        		 	    </span>
        		 	</span> 
        		 <?php endforeach ?>
        		<!-- part B of a hack for the radio button error message-->
        		 <div style="clear:both; height:10px"></div>
        	    </div>
        	    
        	</div>  
        </div>     
        <div class="pull-right cc_saved_cards">
            <?php if( $customerId && $profiles && ($profilesCounter>0) ): ?>
            <div class="switch-card-control">
                <div class="totsy-selective-input-box middle-length" id="use-card-method">
                    <select id="cybersource-use-card-method" name="payment[cybersource_subid]">
                        <option value="" class="use-new-card-control">Choose a Credit/Debit Card</option>
                    <?php foreach( $profiles as $profile ): ?>
                        <?php if(!$profile->getSubscriptionId() || $profile->getIsDefault()== 1 || !$profile->getData('saved_by_customer')) { continue; } ?>
                        <option class="use-saved-card-control" value="<?php echo $profile->getEncryptedSubscriptionId() ?>"><?php echo $this->getFullCcCardType( $profile->getData( 'card_type' ) ) ?> ends with <?php echo $profile->getData( 'last4no' ) ?></option>
                    <?php endforeach ?>
                    </select>
                </div>
                <div>
                     <?php foreach( $profiles as $profile ): ?>
                        <?php if( !$profile->getSubscriptionId() || $profile->getIsDefault()== 1 ) { continue; } ?>
                        <input type="hidden" id="address_<?php echo $profile->getEncryptedSubscriptionId() ?>" value="<?php echo $profile->getData('address_id') ?>" />
                    <?php endforeach ?>
                </div>
            </div>
            <?php endif ?>    
        </div>
    </div>
    <div style="clear:both"></div>
    <div>
        <div class="pull-left cc_num use-new-card-wrapper">
            
            <div class="input-box">
                <input type="text" id="<?php echo $_code ?>_cc_number" name="payment[cc_number]" title="<?php echo $this->__('Credit Card Number') ?>" class="input-text validate-cc-number validate-cc-type-radio" value="<?php echo (($this->__('Credit Card Number')!=='Credit Card Number') ? $this->__('Credit Card Number') : "") ?>" placeholder="<?php echo $this->__('Credit Card Number') ?>" />
            </div>
        </div>
        <div class="rewards_points use-new-card-wrapper">
            <?php echo $this->getLayout()->getBlock('hpcheckout.reward.points')->toHtml(); ?>
        </div>
    </div>
    <div style="clear:both"></div>
    <div>
        <?php if($this->hasVerification()): ?>
        <div class="cc_cvn pull-left use-new-card-wrapper">
            <label for="<?php echo $_code ?>_cc_cid" class="required"><em>*</em><?php echo $this->__('CVN#') ?></label>
            <div class="input-box">
                <div class="v-fix">
                    <input type="text" title="<?php echo $this->__('Card Verification Number') ?>" class="input-text cvv required-entry validate-cc-cvn-radio" id="<?php echo $_code ?>_cc_cid" name="payment[cc_cid]" value="<?php echo (($this->__('Card Verification Number')!=="Card Verification Number") ? $this->__('Card Verification Number') : "") ?>" placeholder="<?php echo $this->__('CVN#') ?>" />
                </div>
            </div>
        </div>
        <?php endif; ?>
        <div class="cc_exp pull-left use-new-card-wrapper">
            <div class="pull-left">
                <div for="<?php echo $_code ?>_expiration" class="lbl"><em>*</em><?php echo $this->__('Expiration') ?></div>
                	<select id="<?php echo $_code ?>_expiration" name="payment[cc_exp_month]" class="month validate-cc-exp required-entry">
                	<?php $_ccExpMonth = $this->getInfoData('cc_exp_month') ?>
                	<?php foreach ($this->getCcMonths() as $k=>$v): ?>
                	    <option value="<?php echo $k?$k:'' ?>" <?php if($k==$_ccExpMonth): ?>selected="selected"<?php endif ?>><?php echo $v ?></option>
                	<?php endforeach ?>
                	</select>	
            </div>
            <div>
                <select id="<?php echo $_code ?>_expiration_yr" name="payment[cc_exp_year]" class="year required-entry">
                <?php $_ccExpYear = $this->getInfoData('cc_exp_year') ?>
                <?php foreach ($this->getCcYears() as $k=>$v): ?>
                    <option value="<?php echo $k?$k:'' ?>" <?php if($k==$_ccExpYear): ?>selected="selected"<?php endif ?>><?php echo $v ?></option>
                <?php endforeach ?>
                </select>
            </div>
        </div>
        <div class="cc_save_card pull-right use-new-card-wrapper">
            <span>
                <input type="checkbox" value="1" name="payment[saved_by_customer]" id="<?php echo $_code ?>_saved" />
            </span>
            <span for="<?php echo $_code ?>_cc_save"><?php echo $this->__(' Save this Credit Card ?') ?>
            </span>
        </div>
    </div> 
    <div style="clear:both"></div>
</div>
        <?php if ($this->hasSsCardType()): ?>
        <li id="<?php echo $_code ?>_cc_type_ss_div">
            <ul class="inner-form">
                <li class="form-alt">
                    <label for="<?php echo $_code ?>_issue" class="required"><em>*</em><?php echo $this->__('Switch/Solo/Maestro(UK Domestic) Only') ?></label>
                </li>
                <li>
                    <label for="<?php echo $_code ?>_cc_issue"><?php echo $this->__('Issue Number') ?></label>
                    <div class="input-box">
                        <input type="text" title="<?php echo $this->__('Issue Number') ?>" class="input-text cvv validate-cc-ukss" id="<?php echo $_code ?>_cc_issue" name="payment[cc_ss_issue]" value="" />
                    </div>
                </li>
                <li>
                    <label for="<?php echo $_code ?>_start_month"><?php echo $this->__('Start Date') ?></label>
                    <div class="input-box">
                        <div class="v-fix">
                            <div class="totsy-selective-input-box short-length">
                            <span><?php echo $this->__('Month') ?></span>
                            <select id="<?php echo $_code ?>_start_month" name="payment[cc_ss_start_month]" class="month validate-cc-ukss">
                            <?php $_ccStartMonth = $this->getInfoData('cc_ss_start_month') ?>
                            <?php foreach ($this->getCcMonths() as $k=>$v): ?>
                                <option value="<?php echo $k?$k:'' ?>" <?php if($k==$_ccStartMonth): ?>selected="selected"<?php endif ?>><?php echo $v ?></option>
                            <?php endforeach ?>
                            </select>
                            </div>
                        </div>
                        <div class="v-fix">
                            <div class="totsy-selective-input-box short-length">
                            <span><?php echo $this->__('Year') ?></span>
                            <select id="<?php echo $_code ?>_start_year" name="payment[cc_ss_start_year]" class="year validate-cc-ukss">
                            <?php $_ccStartYear = $this->getInfoData('cc_ss_start_year') ?>
                            <?php foreach ($this->getSsStartYears() as $k=>$v): ?>
                                <option value="<?php echo $k?$k:'' ?>" <?php if($k==$_ccStartYear): ?>selected="selected"<?php endif ?>><?php echo $v ?></option>
                            <?php endforeach ?>
                            </select>
                            </div>
                         </div>
                    </div>
                </li>
                <li class="adv-container"></li>
            </ul>
            <script type="text/javascript">
            var SSChecked<?php echo $_code ?> = function() {
                var elm = $('<?php echo $_code ?>_cc_type');
                if (elm.value=='SO' || elm.value=='SM') {
                    $('<?php echo $_code ?>_cc_type_ss_div').show();
                } else {
                    $('<?php echo $_code ?>_cc_type_ss_div').hide();
                }
            };
            Event.observe($('<?php echo $_code ?>_cc_type'), 'change', SSChecked<?php echo $_code ?>);
            SSChecked<?php echo $_code ?>();
            </script>
        </li>
        <?php endif; ?>
    </div>
</div>
<script type="text/javascript">
// @TODO: should abstract this out to hpcheckout.js
// disable billing address form controls for saved credit card
jQuery( document ).ready( function($) {
	// cache jQuery objects
	var $billAddySelect = $("#billing-address-select");
	var $newCardWrap = $('.use-new-card-wrapper');
	var $newCardCtrls = $( 'input, select', '.use-new-card-wrapper' );
	var $selectUIWraps = $('.totsy-selective-input-box', '#hpcheckout-billing-wrapper');
	var $billFormInputs = $('#hpcheckout-billing-form :input');
    $( 'select#cybersource-use-card-method' ).change( function() {
    
        if( $( this ).val() == '' ) {
            $newCardWrap.show();
            $newCardCtrls.removeAttr('disabled');
            $selectUIWraps.removeClass('disabled');
            $billAddySelect.removeAttr('disabled');
            //Enable Billing Inputs if credit card not selected
            $billFormInputs.each(function(i) {
                $(this).removeAttr('disabled');
                $(this).val('');
            });
        } else {	
			$newCardWrap.hide();
			$newCardCtrls.attr( 'disabled', 'disabled' ); // disable new card controls
			$selectUIWraps.addClass('disabled'); // 'disable' select UI wrappers
			
			if($("#address_" + $( this ).val()).val()) {
			    $billAddySelect.val($("#address_" + $( this ).val()).val()).change();
			    //Block Billing Inputs if credit card selected
			    $billFormInputs.each(function(i) {
			        if($(this).attr('id') != 'button_ship_to') {
			            $(this).attr('disabled','disabled');
			        }
			    });
			    $billAddySelect.attr('disabled','disabled');
			} else {
			    $billAddySelect.removeAttr('disabled');
			    $billFormInputs.each(function(i) {
			        $(this).removeAttr('disabled');
			    });
			}
        }
    });
});
</script>